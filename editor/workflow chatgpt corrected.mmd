flowchart TD
  %% --- Per-layer pipeline ---
  Source["Source (Footage/Shape/Text â€“ working space; straight alpha)"] --> Masks["Render & Combine Masks (Shape Masks)"]
  Masks --> Effects{"Any Effects?"}
  Effects -->|Yes| EFX["Effects Stack (ping-pong FBOs)"]
  Effects -->|No| Bypass["Bypass"]
  EFX --> Branch{"2D or 3D?"}
  Bypass --> Branch

  Branch -->|2D| Ortho["Ortho Fullscreen Render (ScreenQuad to layerFBO)"]
  Branch -->|3D| Scene3D["3D Scene Render (plane/mesh with transforms)"]

  Ortho --> Styles{"Layer Styles?"}
  Scene3D --> Styles
  Styles -->|Yes| StylesPass["Layer Styles Passes"] --> LayerOut["Layer FBO"]
  Styles -->|No| LayerOut

  %% --- Track matte happens after effects/transforms/styles, before compositing ---
  LayerOut --> TrackMatte["Apply Track Matte / Set Matte (post-effects)"]

  %% --- Stack composite (layer order) ---
  Accum["Accum FBO init transparent black"] --> Accum
  TrackMatte --> Blend["Composite with Blend Mode (straight alpha)"]
  Blend --> Accum

  %% --- Adjustment layers (post over entire accum) ---
  Accum --> Adj{"Adjustment Layer?"}
  Adj -->|Yes| AdjPass["Adjustment Fullscreen Pass"] --> Accum
  Adj -->|No| Accum

